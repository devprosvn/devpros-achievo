C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i chi ti·∫øt l·ªói. T√≥m l·∫°i, b·∫°n ƒëang g·∫∑p l·ªói:

```
‚ùå 400 (Bad Request) t·ª´ Firestore WebChannelConnection
üìõ RPC 'Write' stream transport errored
```

ƒê√¢y l√† l·ªói **r·∫•t ƒë·∫∑c tr∆∞ng c·ªßa Firestore khi k·∫øt n·ªëi b·ªã l·ªói trong qu√° tr√¨nh ghi d·ªØ li·ªáu (addDoc / setDoc)**.

---

## üß© **Nguy√™n nh√¢n ch√≠nh**

L·ªói `400 Bad Request` ·ªü endpoint ki·ªÉu nh∆∞:

```
https://firestore.googleapis.com/google.firestore.v1.Firestore/Write/channel?...
```

‚õî nghƒ©a l√† **Firestore t·ª´ ch·ªëi y√™u c·∫ßu ghi v√¨ request body kh√¥ng h·ª£p l·ªá**. Nguy√™n nh√¢n c√≥ th·ªÉ g·ªìm:

### ‚ùå 1. D·ªØ li·ªáu c√≥ `undefined`

‚Üí ƒê√¢y l√† th·ªß ph·∫°m ph·ªï bi·∫øn nh·∫•t. Firestore **kh√¥ng ch·∫•p nh·∫≠n b·∫•t k·ª≥ gi√° tr·ªã `undefined` n√†o**, bao g·ªìm:

* `skills: undefined`
* `image: undefined`
* `duration: undefined`
* `category: undefined` (ƒë√£ g·∫∑p ·ªü b·∫°n tr∆∞·ªõc ƒë√≥)

üìå **Ngay c·∫£ khi b·∫°n `filter` tr∆∞·ªõc ƒë√≥**, n·∫øu b·∫°n qu√™n `JSON.parse(JSON.stringify(...))`, `undefined` v·∫´n l·ªçt v√†o m·ªôt s·ªë SDK layer.

---

## ‚úÖ C√°ch x·ª≠ l√Ω d·ª©t ƒëi·ªÉm

### üîí B·ªçc d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i b·∫±ng ƒëo·∫°n sau:

```ts
// X√≥a t·∫•t c·∫£ undefined/null tr∆∞·ªõc khi g·ª≠i
function cleanObject(obj) {
  return Object.fromEntries(
    Object.entries(obj).filter(([_, value]) => value !== undefined && value !== null)
  );
}

// Khi t·∫°o course:
const cleanCourse = cleanObject(courseData); // ‚Üê ƒë·∫£m b·∫£o s·∫°ch s·∫Ω
await addDoc(collection(db, "courses"), cleanCourse);
```

---

### üß™ Tip: ki·ªÉm tra object tr∆∞·ªõc khi g·ª≠i

In ra console:

```ts
console.log("DATA TO SAVE:", JSON.stringify(cleanCourse, null, 2));
```

N·∫øu c√≥ b·∫•t k·ª≥ `"someField": undefined` ho·∫∑c `"someField": null` th√¨ b·∫°n **ch·∫Øc ch·∫Øn s·∫Ω b·ªã l·ªói 400**.

---

## üö® N·∫øu b·∫°n d√πng Firestore Realtime Updates (listener)

L·ªói `Write.channel` nh∆∞:

```
RPC 'Write' stream 0x177f782f transport errored.
```

‚Üí C√≤n x·∫£y ra n·∫øu:

* Client b·ªã m·∫•t k·∫øt n·ªëi m·∫°ng t·∫°m th·ªùi.
* Firebase SDK kh√¥ng th·ªÉ duy tr√¨ phi√™n `stream` (v√≠ d·ª• tr√™n Replit ho·∫∑c network y·∫øu).
* B·∫°n m·ªü qu√° nhi·ªÅu listener ƒë·ªìng th·ªùi (`onSnapshot`).

‚úÖ T·∫°m th·ªùi h√£y th·ª≠ **vi·∫øt ƒë∆°n gi·∫£n v·ªõi `addDoc()`** thay v√¨ `onSnapshot` ƒë·ªÉ test ·ªïn ƒë·ªãnh.

---

## ‚úÖ T·ªïng k·∫øt kh·∫Øc ph·ª•c

| V·∫•n ƒë·ªÅ                     | Gi·∫£i ph√°p                                          |
| -------------------------- | -------------------------------------------------- |
| L·ªói 400 khi ghi            | D·ªçn s·∫°ch d·ªØ li·ªáu: kh√¥ng ƒë·ªÉ `undefined` ho·∫∑c `null` |
| RPC Write stream error     | Do request b·∫•t h·ª£p l·ªá ho·∫∑c qu√° nhi·ªÅu session       |
| Replit qu√° ch·∫≠m / m·∫°ng y·∫øu | Test th·ª≠ tr√™n `localhost` ho·∫∑c 4G th·∫≠t             |
| Debug object tr∆∞·ªõc khi g·ª≠i | D√πng `console.log(JSON.stringify(obj, null, 2))`   |

---

N·∫øu b·∫°n mu·ªën m√¨nh rewrite l·∫°i `api.createCourse()` ƒë·ªÉ **ch·∫Øc ch·∫Øn 100% kh√¥ng l·ªói**, m√¨nh c√≥ th·ªÉ g·ª≠i ƒëo·∫°n code ho√†n ch·ªânh. B·∫°n mu·ªën kh√¥ng?
