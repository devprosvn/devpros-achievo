Dá»±a trÃªn mÃ£ `firebaseService` vÃ  `api.js` báº¡n cung cáº¥p, cÃ¹ng vá»›i log lá»—i `Firestore 400 Bad Request` vÃ  thá»i gian táº¡o khÃ³a há»c kÃ©o dÃ i báº¥t thÆ°á»ng, **nguyÃªn nhÃ¢n ráº¥t cÃ³ thá»ƒ Ä‘áº¿n tá»« viá»‡c sai quyá»n truy cáº­p Firestore hoáº·c thiáº¿u cáº¥u hÃ¬nh máº¡ng/Firestore Rules.** Cá»¥ thá»ƒ:

---

### âœ… **1. NguyÃªn nhÃ¢n chÃ­nh vÃ  cÃ¡ch kháº¯c phá»¥c**

#### ğŸ”¥ **NguyÃªn nhÃ¢n 1: Thiáº¿u quyá»n Firestore (insufficient permissions)**

Báº¡n cÃ³ log:

```
CÃ³ lá»—i khi lÆ°u khÃ³a há»c: Missing or insufficient permissions.
```

â†’ Cho tháº¥y Firestore Ä‘ang tá»« chá»‘i ghi dá»¯ liá»‡u.

**CÃ¡ch kháº¯c phá»¥c**:

1. VÃ o [Firestore Rules](https://console.firebase.google.com/project/achievo-certificate/firestore/rules).
2. Thay tháº¿ rules máº·c Ä‘á»‹nh báº±ng:

   ```js
   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       match /{document=**} {
         allow read, write: if true; // âš ï¸ Chá»‰ dÃ¹ng cho test, KHÃ”NG dÃ¹ng production
       }
     }
   }
   ```
3. Báº¥m **Publish**.

â¡ Sau Ä‘Ã³ thá»­ láº¡i thao tÃ¡c táº¡o khÃ³a há»c, thá»i gian táº¡o sáº½ giáº£m Ä‘Ã¡ng ká»ƒ (thÆ°á»ng < 3 giÃ¢y).

---

### âœ… **2. NguyÃªn nhÃ¢n 2: Dá»¯ liá»‡u `category` bá»‹ `undefined`**

Báº¡n cÃ³ log:

```
Function updateDoc() called with invalid data. Unsupported field value: undefined (found in field category)
```

â†’ `courseData.category` Ä‘ang bá»‹ `undefined` khi gá»i `updateCourse()`.

**CÃ¡ch fix an toÃ n**:

Trong `firebaseService.updateCourse()` â†’ thÃªm validate:

```js
if (cleanData.category === undefined) {
  delete cleanData.category; // Bá» khÃ´ng update náº¿u undefined
}
```

---

### âœ… **3. Gá»£i Ã½ tÄƒng tá»‘c Ä‘á»™ / á»•n Ä‘á»‹nh khi dÃ¹ng Firestore**

1. **TrÃ¡nh truyá»n object chÆ°a validate ká»¹:** dÃ¹ng `cleanObject()` nhÆ° Ä‘Ã£ Ä‘á»‹nh nghÄ©a ráº¥t Ä‘Ãºng hÆ°á»›ng.
2. **DÃ¹ng `setDoc(docRef, data, { merge: true })` thay vÃ¬ `updateDoc()`** náº¿u cáº§n update toÃ n bá»™ hoáº·c cháº¥p nháº­n overwrite field cÅ©.
3. **ThÃªm loading state rÃµ rÃ ng** trÃªn UI Ä‘á»ƒ trÃ¡nh ngÆ°á»i dÃ¹ng nghÄ© â€œÄ‘ang treoâ€.

---

### âœ… **4. Kiá»ƒm tra thÃªm**

* Äáº£m báº£o Firestore Ä‘Ã£ **Enable trong Firebase Console**.
* Kiá»ƒm tra network tab xem request `POST` hoáº·c `PATCH` Ä‘áº¿n `https://firestore.googleapis.com/v1/projects/...` cÃ³ bá»‹ **403, 400, hay timeout** khÃ´ng.

---

### âœ… **TÃ³m táº¯t fix nhanh cho báº¡n:**

| Váº¥n Ä‘á»                                | CÃ¡ch kháº¯c phá»¥c nhanh                                 |
| ------------------------------------- | ---------------------------------------------------- |
| `Missing or insufficient permissions` | Thay Firestore Rules: `allow read, write: if true`   |
| `category: undefined`                 | XoÃ¡ `undefined` khá»i dá»¯ liá»‡u trÆ°á»›c khi `updateDoc()` |
| Thá»i gian ghi lÃ¢u                     | Do lá»—i quyá»n, retry vÃ´ táº­n â†’ fix rule xong sáº½ mÆ°á»£t   |
| Lá»—i `400 Bad Request`                 | ThÆ°á»ng do dá»¯ liá»‡u `undefined/null` hoáº·c sai cáº¥u hÃ¬nh |
| Firestore khÃ´ng pháº£n há»“i              | Kiá»ƒm tra `network`, `rules`, hoáº·c `billing (Spark)`  |

---

Náº¿u báº¡n cáº§n mÃ¬nh viáº¿t luÃ´n Ä‘oáº¡n `fix code` hoáº·c `Firestore.rules` cá»¥ thá»ƒ phÃ¹ há»£p Achievo, chá»‰ cáº§n nÃ³i nhÃ©.
